x-logging:
  &default-logging
  options:
    max-size: '20m'
    max-file: '3'
  driver: json-file

services:

  proxy:
    container_name: proxy
    image: traefik:2.11 
    command:
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - ./traefik:/etc/traefik:ro
    ports:
      - "80:80" 
      - "443:443"
      - "8080:8080"
    networks:
     - rt-transcriber   
    restart: unless-stopped

  manager:
    image: airenas/docker-kaldi-gstreamer-server:${gstreamer_version}
    container_name: manager
    logging: *default-logging
    restart: unless-stopped
    networks:
     - rt-transcriber   
    entrypoint: ["python", "/opt/kaldi-gstreamer-server/kaldigstserver/master_server.py", "--port=9090"]

  worker:
    image: airenas/docker-kaldi-gstreamer-server:${gstreamer_version}
    # container_name: worker
    logging: *default-logging
    restart: unless-stopped
    entrypoint: ["python", "/opt/kaldi-gstreamer-server/kaldigstserver/worker.py", "-c", "/opt/models/lt.yaml", "-u", "ws://manager:9090/worker/ws/speech"]
    environment:
     - GST_PLUGIN_PATH=/opt/gst-kaldi-nnet2-online/src/:/opt/kaldi/src/gst-plugin/
     - PHONES2WORD_SERVER_URL=http://phones2word:3000/phones2word
    networks:
     - rt-transcriber    
    volumes:
     - ${ASR_DIR}:/opt/models:ro  

  wrapper:
    image: airenas/rt-transcriber-wrapper:${wrapper_version}
    container_name: rt-wrapper
    logging: *default-logging
    restart: unless-stopped
    networks:
     - rt-transcriber   
    environment:
     - STATUS_URL=ws://manager:9090/client/ws/status
     - SPEECH_URL=ws://manager:9090/client/ws/speech  
     - JOINER_URL=http://norm-num:3000/invnorm_num
     - PUNCTUATOR_URL=http://punctuation-service:8000/punctuation   
     - REDIS_URL=redis://redis-cache:6379/0
     - REDIS_ENCRYPTIONKEY=${CACHE_ENCRYPTION_KEY}
     - REDIS_TTL=6h
    labels:
     - "traefik.enable=true"
     - "traefik.http.routers.kaldi-proxy.rule=PathPrefix(`/{path:(?i)client/}`)"
     - "traefik.http.routers.kaldi-proxy.middlewares=rate-limit@file,authware@docker"
     - "traefik.http.routers.kaldi-proxy.entrypoints=web,websecure"
     - "traefik.http.routers.kaldi-proxy.tls=true"
     - "traefik.http.services.kaldi-proxy.loadbalancer.server.port=8000"  

  redis-cache:
    container_name: redis-cache
    image: redis:7.2.5-alpine3.19
    restart: unless-stopped
    logging: *default-logging   
    networks:
     - rt-transcriber   
    
  tensorflow:
    image: tensorflow/serving:1.15.0
    environment:
      MODEL_NAME: punctuation
      MODEL_BASE_PATH: /models
    volumes:  
      - ${PUNCTUATION_DIR}/models:/models
    restart: unless-stopped 
    networks:
     - rt-transcriber   
    logging: *default-logging

  authware:
    image: airenas/authware:${authware_version}
    container_name: authware
    environment:
      - RUST_LOG=debug,tower_http=warn,h2=warn,rustls=warn,hyper_util=warn 
      - SESSION_TIMEOUT=6h
      - INACTIVITY_TIMEOUT=30m
      - SAMPLE_USERS=${SAMPLE_USERS}
      - HOST=authware
      - REDIS_URL=redis://redis:6379
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      - AUTH_WS_URL=${AUTH_WS_URL}
      - AUTH_WS_USER=${AUTH_WS_USER}
      - AUTH_WS_PASS=${AUTH_WS_PASS}
      - AUTH_APP_CODE=${AUTH_WS_APP_CODE}
    restart: unless-stopped 
    networks:
     - rt-transcriber
    logging: *default-logging  
    labels:
     - "traefik.enable=true"
     - "traefik.http.routers.authware.rule=PathPrefix(`/auth`)"
     - "traefik.http.routers.authware.entrypoints=websecure"
     - "traefik.http.routers.authware.tls=true"
     - "traefik.http.middlewares.authware.forwardauth.address=https://authware:8000/auth"  
     - "traefik.http.middlewares.authware.forwardauth.trustForwardHeader=true"
     - "traefik.http.middlewares.authware.forwardauth.tls.insecureSkipVerify=true"
     - "traefik.http.middlewares.authware.forwardauth.authResponseHeaders=User-Info"
     - "traefik.http.services.authware.loadbalancer.server.port=8000"
     - "traefik.http.services.authware.loadbalancer.server.scheme=https"
     - "traefik.http.services.authware.loadbalancer.serversTransport=skip-verify-tls-transport@file"

  redis:
    container_name: redis
    image: redis:7.2.5-alpine3.19
    restart: unless-stopped
    logging: *default-logging   
    networks:
     - rt-transcriber
      
  punctuation-service:
    image: airenas/list-punctuation:0.3.1
    restart: unless-stopped
    logging: *default-logging
    volumes:
      - ${PUNCTUATION_DIR}/3.0:/model
    environment:
      TF_URL: tensorflow:8500 
    networks:
     - rt-transcriber     

  norm-num:
    image: intelektikalt/invnorm-nums:${nnum_version}
    container_name: norm-num
    logging: *default-logging
    restart: unless-stopped
    networks:
     - rt-transcriber   

  phones2word:
    image: intelektikalt/asr-phoneme2word:0.0.1
    container_name: phones2word
    logging: *default-logging
    restart: unless-stopped  
    networks:
     - rt-transcriber   

  rt-transcriber-gui:
    image: airenas/rt-transcriber-gui:${rt_transcriber_gui_version}
    container_name: rt-transcriber-gui
    logging: *default-logging
    restart: unless-stopped
    networks:
     - rt-transcriber   
    environment:
      - BASE_PATH=/${RT_TRANSCRIBER_PATH}/
      - SERVER_URL=${KALDI_WS}
      - DATA_SERVER_URL=${DATA_SERVER_URL}
      - AUTH_URL=${AUTH_URL}
    labels:
     - "traefik.enable=true"
     - "traefik.http.routers.rt-transcriber.rule=PathPrefix(`/${RT_TRANSCRIBER_PATH}`)"
     - "traefik.http.routers.rt-transcriber.middlewares=rate-limit@file,rt-transcriber"
     - "traefik.http.middlewares.rt-transcriber.stripprefix.prefixes=/${RT_TRANSCRIBER_PATH}"
     - "traefik.http.routers.rt-transcriber.entrypoints=web,websecure"
     - "traefik.http.routers.rt-transcriber.tls=true"
     - "traefik.http.routers.rt-transcriber.service=rt-transcriber"
     - "traefik.http.services.rt-transcriber.loadbalancer.server.port=8000"     

networks:
  rt-transcriber: